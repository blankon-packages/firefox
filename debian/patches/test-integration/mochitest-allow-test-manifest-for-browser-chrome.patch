# HG changeset patch
# Parent 0e8cbb3674e7a0aaa09daa97e5c91f002219ce06
# User Chris Coulson <chris.coulson@canonical.com>

diff --git a/testing/mochitest/browser-harness.xul b/testing/mochitest/browser-harness.xul
--- a/testing/mochitest/browser-harness.xul
+++ b/testing/mochitest/browser-harness.xul
@@ -8,16 +8,19 @@
         xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
         onload="TestStart();"
         title="Browser chrome tests"
         width="1024">
   <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/MozillaLogger.js"/>
   <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/LogController.js"/>
   <script type="application/javascript" src="chrome://mochikit/content/chrome-harness.js"/>
   <script type="application/javascript" src="chrome://mochikit/content/chunkifyTests.js"/>
+  <!-- We need this to make setup.js happy. Perhaps filterTests() should also exist in chrome-harness.js? -->
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/TestRunner.js"/>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/setup.js"/>
   <style xmlns="http://www.w3.org/1999/xhtml"><![CDATA[
     #results {
       margin: 5px;
       background-color: window;
       -moz-user-select: text;
     }
 
     #summary {
@@ -171,26 +174,26 @@
 
       // load server.js in so we can share template functions
       var scriptLoader = Cc["@mozilla.org/moz/jssubscript-loader;1"].
                            getService(Ci.mozIJSSubScriptLoader);
       var srvScope = {};
       scriptLoader.loadSubScript('chrome://mochikit/content/server.js',
                                  srvScope);
 
-      var fileNames = [];
       var fileNameRegexp = /browser_.+\.js$/;
-      srvScope.arrayOfTestFiles(links, fileNames, fileNameRegexp);
+      srvScope.arrayOfTestFiles(links, gTestList, fileNameRegexp);
+      gTestList = filterTests(gConfig.testManifest, gConfig.runOnly);
 
       if (gConfig.totalChunks && gConfig.thisChunk) {
-        fileNames = chunkifyTests(fileNames, gConfig.totalChunks,
+        gTestList = chunkifyTests(gTestList, gConfig.totalChunks,
                                   gConfig.thisChunk, gConfig.chunkByDir);
       }
 
-      return fileNames.map(function (f) new browserTest(f));
+      return gTestList.map(function (f) new browserTest(f));
     }
 
     function setStatus(aStatusString) {
       document.getElementById("status").value = aStatusString;
     }
 
     function runTests() {
       var windowMediator = Cc['@mozilla.org/appshell/window-mediator;1'].
